<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>中央競馬 自動スコアリングツール</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body { font-family:sans-serif; background:#fafafa; padding:10px; }
textarea { width:100%; height:120px; margin-bottom:6px; font-size:16px; }
button { width:100%; padding:14px; font-size:18px; margin-bottom:6px; border-radius:10px; }

/* レース・ワイドの表示 */
.race, .wide {
  display:block;
  padding:6px 10px;
  margin-bottom:6px;
  border-radius:8px;
  font-weight:bold;
  box-shadow:0 2px 4px rgba(0,0,0,0.1);
  word-wrap: break-word;      /* 長い馬名も折り返し */
  white-space: normal;         /* 横幅に合わせて折り返し */
  overflow: visible;           /* はみ出しても表示 */
}

.race small { font-weight: normal; font-size: 0.85em; margin-left:6px; }

.a-axis { background:#ffdddd; border-left:6px solid #e60000; }
.b-axis { background:#fff0cc; border-left:6px solid #ff9900; }
.skip { background:#f0f0f0; color:#999; }

.wide { background:#ddf0ff; border-left:6px solid #3399ff; }
#result { margin-top:10px; }
</style>
</head>
<body>

<h3>① 単勝・複勝データ貼り付け</h3>
<textarea id="odds" placeholder="人気+馬番がくっついたnetkeiba形式貼り付け"></textarea>

<h3>② ワイドデータ貼り付け（任意）</h3>
<textarea id="wide" placeholder="人気列含むnetkeiba形式貼り付け"></textarea>

<button onclick="calculate()">スコア計算・買い目表示</button>
<button onclick="clearAll()">クリア</button>

<h3>結果</h3>
<div id="result"></div>

<script>
// --- クリア ---
function clearAll(){ odds.value=""; wide.value=""; result.innerHTML=""; }

// --- 単勝・複勝解析 ---
function parseOdds(text){
  const lines = text.split("\n").map(l=>l.trim()).filter(l=>l!=="");
  let horses=[], horse={};

  for(let i=0;i<lines.length;i++){
    let l = lines[i];
    if(["人気","馬番","馬名","単勝","複勝(3着払い)"].includes(l)) continue;
    if(l === "-") continue;

    // 人気+馬番がくっついた行を分割
    if(/^\d{2,3}$/.test(l) && !horse.pop){
      const popStr = l.length === 2 ? l[0] : l.slice(0,l.length-2);
      const numStr = l.slice(popStr.length);
      horse.pop = parseInt(popStr);
      horse.num = numStr;
      continue;
    }

    if(!horse.name){
      horse.name = l;
      continue;
    }
    if(!horse.win){
      horse.win = parseFloat(l);
      continue;
    }
    if(!horse.place){
      // 複勝最後の数値を取得
      let j=i;
      while(lines[j]==="-" || isNaN(parseFloat(lines[j]))) j++;
      horse.place = parseFloat(lines[j]);
      i=j;
      horses.push({...horse, score:0});
      horse={};
    }
  }
  return horses;
}

// --- ワイド解析（下限オッズ使用） ---
function parseWide(text){
  const lines = text.split("\n").map(l=>l.trim()).filter(l=>l!=="");
  let wideArr=[], buffer=[];
  lines.forEach(l=>{
    if(["人気","組番","オッズ"].includes(l)) return;
    if(l === "-") return;
    buffer.push(l);
    if(buffer.length===3){
      wideArr.push({combo: buffer[1], odds: parseFloat(buffer[2])});
      buffer=[];
    }
  });
  return wideArr;
}

// --- 推奨ワイド3点抽出 ---
function selectTopWide(horses, wideArr){
  let selected=[];
  const axes=horses.filter(h=>h.score>=78).map(h=>h.num.toString());
  wideArr.forEach(w=>{
    let nums=w.combo.split("-").map(x=>x.trim());
    if(axes.includes(nums[0]) || axes.includes(nums[1])) selected.push(w);
  });
  selected = selected.filter(w=>w.odds>=1.5 && w.odds<=15);
  return selected.slice(0,3);
}

// --- スコア計算 ---
function calculate(){
  let horses=parseOdds(odds.value);
  if(horses.length===0){ result.innerHTML="データを認識できません"; return; }

  // 単勝断層・複勝・人気で加点
  horses.sort((a,b)=>a.win-b.win);
  horses.forEach((h,i)=>h.pop=i+1);

  if(horses[2] && horses[2].win >= horses[1].win*1.8){
    horses[0].score+=40;
    horses[1].score+=38;
  }

  horses.forEach(h=>{
    if(h.place<=1.3) h.score+=30;
    else if(h.place<=1.6) h.score+=22;
    else if(h.place<=2.1) h.score+=18;
    const bal=h.win*h.place;
    if(bal<=4.5) h.score+=15;
    else if(bal<=6.0) h.score+=10;
    if(h.pop<=2) h.score+=10;
    else if(h.pop<=4) h.score+=7;
  });

  horses.sort((a,b)=>b.score-a.score);

  let html="";
  horses.forEach(h=>{
    let cls="skip", txt="SKIP";
    if(h.score>=85){ cls="a-axis"; txt="A軸｜ワイド3点 1500円"; }
    else if(h.score>=78 && h.score<=84 && h.win>=2.8 && h.win<=7.5 && h.place>=1.4 && h.pop!==1){ cls="b-axis"; txt="B軸｜ワイド2点 1000円"; }
    html+=`<div class="race ${cls}">馬番${h.num}｜${h.name}｜スコア${h.score}<br><small>${txt}</small></div>`;
  });

  let wideArr=parseWide(wide.value);
  if(wideArr.length>0){
    const topWide = selectTopWide(horses, wideArr);
    html+="<h4>推奨ワイド3点（下限オッズ使用）</h4>";
    topWide.forEach(w=>{
      html+=`<div class="wide">${w.combo}｜オッズ${w.odds}</div>`;
    });
  }

  result.innerHTML=html;
}
</script>
</body>
</html>