<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ワイド3点 自動最適化ツール</title>
<style>
body { font-family: -apple-system, sans-serif; margin: 15px; background:#f5f5f5; }
h2 { text-align:center; }
textarea { width: 100%; padding: 10px; font-size:16px; }
button { width: 100%; padding: 15px; font-size:18px; border:none; border-radius:8px; margin:10px 0; }
.generate-btn { background:#007AFF; color:white; }
.clear-btn { background:#FF3B30; color:white; }
.result-card { background:white; padding:15px; border-radius:10px; margin-bottom:10px; box-shadow:0 2px 5px rgba(0,0,0,0.2); }
.result-card h3 { margin:0 0 5px 0; }
</style>
</head>
<body>
<h2>ワイド3点 自動最適化ツール</h2>

<p>単勝オッズを入力（馬番,オッズのカンマ区切り）</p>
<textarea id="winOdds" rows="3" placeholder="例: 1,2.0,2,3.5,3,5.0,4,8.0"></textarea>

<p>ワイドオッズを入力（ペア,オッズのカンマ区切り）</p>
<textarea id="wideOdds" rows="3" placeholder="例: 1-2,4.2,1-3,7.5,1-4,12.0,2-3,5.5,2-4,10.0,3-4,15.0"></textarea>

<label>1レース予算: <span id="budgetLabel">1500</span>円</label>
<input type="range" id="budgetRange" min="500" max="5000" step="100" value="1500" oninput="document.getElementById('budgetLabel').innerText=this.value">

<button class="generate-btn" onclick="calculate()">買い目生成</button>
<button class="clear-btn" onclick="clearData()">データクリア</button>

<h3>結果</h3>
<div id="result"></div>

<script>
function calculate(){
    const winInput = document.getElementById("winOdds").value.trim();
    const wideInput = document.getElementById("wideOdds").value.trim();
    if(!winInput || !wideInput){ alert("単勝オッズとワイドオッズを両方入力してください"); return; }

    const budget = parseInt(document.getElementById("budgetRange").value);

    // 単勝オッズ配列
    const winData = winInput.split(',').map(s=>s.trim());
    let horses = [];
    for(let i=0;i<winData.length;i+=2){
        horses.push({num:winData[i], odds:parseFloat(winData[i+1])});
    }
    horses.sort((a,b)=>a.odds-b.odds);

    // 断層判定で軸馬決定
    let maxDiff = 0, breakIndex = 0;
    for(let i=0;i<horses.length-1;i++){
        let diff = horses[i+1].odds - horses[i].odds;
        if(diff>maxDiff){ maxDiff = diff; breakIndex=i; }
    }
    let axisCandidates = horses.slice(0, breakIndex+1);
    let axis = axisCandidates[0];

    // ワイドオッズ配列
    const wideData = wideInput.split(',').map(s=>s.trim());
    let wideMap = {}; // {"1-2":4.2, ...}
    for(let i=0;i<wideData.length;i+=2){
        wideMap[wideData[i]] = parseFloat(wideData[i+1]);
    }

    // 軸馬とのペアだけ抽出
    let flowCandidates = [];
    horses.forEach(h=>{
        if(h.num!==axis.num){
            let pair1 = axis.num+'-'+h.num;
            let pair2 = h.num+'-'+axis.num;
            if(wideMap[pair1]!==undefined) flowCandidates.push({num:h.num, odds:wideMap[pair1]});
            else if(wideMap[pair2]!==undefined) flowCandidates.push({num:h.num, odds:wideMap[pair2]});
        }
    });

    // ワイドオッズ昇順で上位2頭選定（断層的に最大2点＋軸で3点買い）
    flowCandidates.sort((a,b)=>a.odds-b.odds);
    flowCandidates = flowCandidates.slice(0,2);

    // 人気別補正（単純にワイドオッズ低いほど当たりやすい仮定）
    function hitProb(odds){
        if(odds<=5) return 0.45;
        if(odds<=10) return 0.30;
        return 0.15;
    }

    // 各買い目の期待値計算
    let bets = flowCandidates.map(t=>{
        let prob = hitProb(t.odds);
        let expected = prob * t.odds;
        return {num:t.num, odds:t.odds, prob:prob, expected:expected};
    });

    // 投資額配分 = 期待値比率に応じて自動調整
    let totalExpected = bets.reduce((sum,b)=>sum+b.expected,0);
    bets.forEach(b=>{ b.invest = Math.floor(b.expected / totalExpected * budget); });

    // 結果表示
    let resultHTML = `<div class="result-card"><h3>軸馬: ${axis.num}</h3><ul>`;
    bets.forEach(b=>{
        resultHTML += `<li>${axis.num}-${b.num} 投資額: ${b.invest}円 (期待値: ${(b.expected*b.invest).toFixed(0)}円)</li>`;
    });
    resultHTML += `</ul>`;
    let totalEV = bets.reduce((sum,b)=>sum+b.expected*b.invest,0);
    resultHTML += `<p>合計期待値: ${totalEV.toFixed(0)}円</p></div>`;

    document.getElementById("result").innerHTML = resultHTML;
}

function clearData(){
    document.getElementById("winOdds").value = '';
    document.getElementById("wideOdds").value = '';
    document.getElementById("result").innerHTML = '';
}
</script>
</body>
</html>