<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ワイド期待値判定（理由表示付き）</title>
<style>
body { font-family: -apple-system,BlinkMacSystemFont,"Helvetica Neue","Arial",sans-serif; padding:20px; background:#f9f9f9; }
h2,p { font-size:18px; }
textarea,input { width:100%; font-size:16px; margin-bottom:10px; padding:4px; }
button { font-size:16px; padding:6px 12px; margin-bottom:10px; }
ul { list-style:none; padding:0; }
li { display:flex; flex-wrap:wrap; gap:6px; align-items:center; margin:4px 0; font-size:16px; }
.icon { font-weight:bold; font-size:18px; }
.green { color:green; }
.red { color:red; }
pre { background:#eee; padding:10px; font-size:16px; overflow-x:auto; }
.highlight { background:#ffffcc; padding:4px; }
.reason { color:red; font-weight:bold; }
</style>
</head>
<body>

<h2>ワイド期待値上位3点判定ツール</h2>

<p>馬データ貼り付け:</p>
<textarea id="horseInput" placeholder="例: 1 3&#10;アイデアユー&#10;1.8 1.1-1.1"></textarea>
<button onclick="document.getElementById('horseInput').value=''; document.getElementById('horseConverted').textContent='';">馬データクリア</button>
<pre id="horseConverted"></pre>

<p>ワイドデータ貼り付け:</p>
<textarea id="wideInput" placeholder="例: 1	3-12	1.8-2.1"></textarea>
<button onclick="document.getElementById('wideInput').value=''; document.getElementById('wideConverted').textContent=''; document.getElementById('wideList').innerHTML='';">ワイドデータクリア</button>
<pre id="wideConverted"></pre>

<button id="convertBtn">変換して表示・軸馬判定</button>

<p>軸馬: <span id="axisHorse"></span></p>
<ul id="wideList"></ul>

<script>
// ---------- 馬データ変換 ----------
function parseHorseData(text){
  const lines=text.replace(/\r/g,"").split("\n").map(l=>l.trim()).filter(l=>l!=="");
  const horses=[];
  for(let i=0;i<lines.length;i+=3){
    if(!lines[i]) continue;
    const no = Number(lines[i].trim().split(/\s+/)[1]);
    const name = lines[i+1].trim();
    const odds = parseFloat(lines[i+2].trim().split(/\s+/)[0]);
    horses.push({no,name,odds});
  }
  return horses;
}

// ---------- ワイドデータ変換 ----------
function parseWideData(text){
  const lines=text.replace(/\r/g,"").split("\n").map(l=>l.trim()).filter(l=>l!=="");
  const result=[];
  lines.forEach(line=>{
    const parts = line.split(/\t/).map(p=>p.trim());
    if(parts.length<3) return;
    const pair = parts[1];
    const odds = parseFloat(parts[2].split('-')[0]);
    if(!isNaN(odds)) result.push({pair,odds});
  });
  return result;
}

// ---------- 軸馬判定 ----------
function decideAxisHorse(horses,wideOdds){
  const sorted=[...horses].sort((a,b)=>a.odds-b.odds);
  let candidates=[];
  let reason="";

  // 1. オッズ断層で候補抽出
  for(let i=1;i<sorted.length;i++){
    if(sorted[i].odds/sorted[i-1].odds>=2.0) candidates.push({...sorted[i],rank:i+1});
  }

  if(candidates.length===0){
    return {axis:null,reason:"人気上位にオッズ断層がなく、軸馬候補なし"};
  }

  // 2. 候補の中からワイド条件（下限オッズ4.5以上）を満たす馬を探す
  const valid = candidates.filter(h=>hasWideValue(h.no,wideOdds));
  if(valid.length===0){
    return {axis:null,reason:"候補馬はいるが、ワイド下限オッズが4.5未満で買い目対象外"};
  }

  return {axis:valid[0],reason:""};
}

function hasWideValue(axisNo,wideOdds){
  return wideOdds.some(w=>{
    const [a,b]=w.pair.split("-").map(Number);
    return (a===axisNo||b===axisNo)&&w.odds>=4.5;
  });
}

// ---------- 上位3点選定 ----------
function selectTop3Wides(axisNo,wideOdds){
  const candidates = wideOdds.filter(w=>{
    const [a,b]=w.pair.split("-").map(Number);
    return (a===axisNo||b===axisNo)&&w.odds>=4.5;
  });
  candidates.forEach(w=>{
    w.reason = w.odds>=4.5 ? "条件クリア" : "オッズ低く除外";
  });
  candidates.sort((a,b)=>b.odds-a.odds); // オッズ順
  return candidates.slice(0,3);
}

// ---------- 表示 ----------
document.getElementById("convertBtn").addEventListener("click",()=>{
  const horses=parseHorseData(document.getElementById("horseInput").value);
  const wideOdds=parseWideData(document.getElementById("wideInput").value);

  // 変換後テキスト
  document.getElementById("horseConverted").textContent=
    horses.map(h=>`${h.no} ${h.name} ${h.odds}`).join("\n");
  document.getElementById("wideConverted").textContent=
    wideOdds.map(w=>`${w.pair} ${w.odds}`).join("\n");

  // 軸馬判定
  const {axis, reason} = decideAxisHorse(horses,wideOdds);
  const axisSpan=document.getElementById("axisHorse");
  const list=document.getElementById("wideList");
  list.innerHTML="";

  if(axis){
    axisSpan.textContent=`${axis.no} ${axis.name}（単勝 ${axis.odds}倍）`;
    const top3=selectTop3Wides(axis.no,wideOdds);
    top3.forEach(w=>{
      const li=document.createElement("li");
      const icon=document.createElement("span");
      icon.textContent=w.odds>=4.5?"✅":"❌";
      icon.className=w.odds>=4.5?"icon green":"icon red";
      li.appendChild(icon);

      const textSpan=document.createElement("span");
      textSpan.textContent=`${w.pair} ${w.odds}倍 - 理由: ${w.reason}`;
      li.appendChild(textSpan);

      li.className="highlight";
      list.appendChild(li);
    });
  } else {
    axisSpan.innerHTML=`該当なし（見送り）<span class="reason">理由: ${reason}</span>`;
  }
});
</script>

</body>
</html>