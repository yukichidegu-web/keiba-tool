<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ä¸­å¤®ç«¶é¦¬ EVå¼·åŒ–ãƒ¯ã‚¤ãƒ‰ãƒ„ãƒ¼ãƒ«</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body { font-family:sans-serif; background:#fafafa; padding:10px; }
textarea { width:100%; height:120px; margin-bottom:6px; }
button { width:100%; padding:14px; font-size:18px; margin-bottom:6px; border-radius:10px; }
.race { padding:10px; margin-bottom:10px; border-radius:8px; font-weight:bold; box-shadow:0 2px 4px rgba(0,0,0,0.1);}
.a-axis { background:#ffdddd; border-left:6px solid #e60000; }
.b-axis { background:#fff0cc; border-left:6px solid #ff9900; }
.skip   { background:#f0f0f0; color:#999; }
.summary { background:#eef; padding:10px; border-radius:8px; margin-top:10px; font-weight:bold;}
</style>
</head>
<body>

<h3>â‘  å˜å‹ãƒ»è¤‡å‹ãƒ‡ãƒ¼ã‚¿è²¼ã‚Šä»˜ã‘</h3>
<textarea id="odds" placeholder="äººæ°—, é¦¬ç•ª, é¦¬å, å˜å‹, è¤‡å‹(3ç€æ‰•ã„)"></textarea>

<h3>â‘¡ ãƒ¯ã‚¤ãƒ‰ä¸‹é™ã‚ªãƒƒã‚ºãƒ‡ãƒ¼ã‚¿è²¼ã‚Šä»˜ã‘ï¼ˆä»»æ„ï¼‰</h3>
<textarea id="wide" placeholder="äººæ°—, çµ„ç•ª, ä¸‹é™ã‚ªãƒƒã‚º"></textarea>

<button onclick="calculate()">ã‚¹ã‚³ã‚¢è¨ˆç®—ãƒ»è²·ã„ç›®è¡¨ç¤º</button>
<button onclick="clearAll()">ã‚¯ãƒªã‚¢</button>

<h3>çµæœ</h3>
<div id="result"></div>

<script>
function clearAll(){ odds.value=""; wide.value=""; result.innerHTML=""; }

function parseOdds(text){
  const lines=text.split("\n").map(l=>l.trim()).filter(l=>l!=="");
  let horses=[], buffer=[];
  lines.forEach(l=>{
    if(!isNaN(l)) buffer.push(parseFloat(l));
    else buffer.push(l);
    if(buffer.length===5){
      horses.push({num:buffer[1],name:buffer[2],win:parseFloat(buffer[3]),place:parseFloat(buffer[4]),score:0,pop:0});
      buffer=[];
    }
  });
  return horses;
}

function parseWide(text){
  const lines=text.split("\n").map(l=>l.trim()).filter(l=>l!=="");
  let wideArr=[], buffer=[];
  lines.forEach(l=>{
    if(!isNaN(l)) buffer.push(parseFloat(l));
    else if(l.includes("-")) buffer.push(l);
    if(buffer.length===3){
      wideArr.push({combo:buffer[1], odds:buffer[0]});
      buffer=[];
    }
  });
  return wideArr;
}

// ç¢ºç‡è£œæ­£ï¼ˆã‚¹ã‚³ã‚¢ï¼‹ã‚ªãƒƒã‚ºï¼‰
function calcProb(score, odds){
  let base=0;
  if(score>=90) base=0.35;
  else if(score>=85) base=0.30;
  else if(score>=78) base=0.25;
  else base=0.15;
  let oddsProb = 1/odds;
  let prob = base*0.6 + oddsProb*0.4;
  if(prob>0.8) prob=0.8;
  if(prob<0.05) prob=0.05;
  return prob;
}

function calculate(){
  let horses=parseOdds(odds.value);
  if(horses.length===0){ result.innerHTML="ãƒ‡ãƒ¼ã‚¿ã‚’èªè­˜ã§ãã¾ã›ã‚“"; return; }

  horses.sort((a,b)=>a.win-b.win);
  horses.forEach((h,i)=>h.pop=i+1);

  if(horses[2] && horses[2].win>=horses[1].win*1.8){ horses[0].score+=40; horses[1].score+=38; }
  horses.forEach(h=>{
    if(h.place<=1.3) h.score+=30;
    else if(h.place<=1.6) h.score+=22;
    else if(h.place<=2.1) h.score+=18;
    const bal=h.win*h.place;
    if(bal<=4.5) h.score+=15;
    else if(bal<=6) h.score+=10;
    if(h.pop<=2) h.score+=10;
    else if(h.pop<=4) h.score+=7;
  });

  horses.sort((a,b)=>b.score-a.score);

  let html="", raceEV=0;
  let aAxis=[], bAxis=[];

  // ãƒ¯ã‚¤ãƒ‰ä¸‹é™ã‚ªãƒƒã‚º
  let wideArr=parseWide(wide.value);
  let oddsMap={};
  wideArr.forEach(w=>{
    oddsMap[w.combo]=w.odds;
  });

  horses.forEach(h=>{
    let bet=0, cls="skip", txt="SKIP";
    if(h.score>=85){ bet=1500; cls="a-axis"; aAxis.push(h); }
    else if(h.score>=78){ bet=1000; cls="b-axis"; bAxis.push(h); }
    if(bet>0){
      // ä¸‹é™ã‚ªãƒƒã‚ºåˆ©ç”¨
      let od=oddsMap[h.num+"-"+h.num]||h.win;
      let prob=calcProb(h.score, od);
      let ev=Math.round(prob*od*bet);
      raceEV+=ev;
      let purch=ev>=bet?"ğŸŸ¢è³¼å…¥å¯":"ğŸ”´ã‚¹ã‚­ãƒƒãƒ—";
      txt=`${cls==="a-axis"?"Aè»¸":"Bè»¸"}ï½œ${bet}å††ï½œç¢ºç‡${(prob*100).toFixed(1)}%ï½œEV${ev}å††ï½œ${purch}`;
    }
    html+=`<div class="race ${cls}">é¦¬ç•ª${h.num}ï½œ${h.name}ï½œã‚¹ã‚³ã‚¢${h.score}<br><small>${txt}</small></div>`;
  });

  let totalBet=aAxis.length*1500 + bAxis.length*1000;
  html+=`<div class="summary">ğŸ¯ ã“ã®ãƒ¬ãƒ¼ã‚¹ã®æœŸå¾…åæ”¯: ${raceEV-totalBet}å††<br>æŠ•å…¥é¡: ${totalBet}å††</div>`;

  // æœˆé–“åæ”¯è¨ˆç®—ï¼ˆä¾‹: 8æ—¥Ã—6ãƒ¬ãƒ¼ã‚¹ï¼‰
  let monthlyEV=(raceEV-totalBet)*8*6;
  html+=`<div class="summary">ğŸ“… æœˆé–“æœŸå¾…åæ”¯ï¼ˆ8æ—¥Ã—6ãƒ¬ãƒ¼ã‚¹æƒ³å®šï¼‰: ${monthlyEV}å††</div>`;

  result.innerHTML=html;
}
</script>
</body>
</html>